<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5v5 Aufstellung – FIFA Karten</title>

  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      background: #0f172a;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }
    .container {
      width: 100%;
      max-width: 1100px;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }
    .subtitle {
      color: #9ca3af;
      margin-bottom: 1.2rem;
      font-size: 0.95rem;
    }

    .nav-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 8px;
      flex-wrap: wrap;
    }
    .nav-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.85);
      padding: 6px 12px;
      font-size: 0.8rem;
      color: #e5e7eb;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.1s, transform 0.08s, box-shadow 0.08s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .nav-btn:hover {
      background: rgba(30,64,175,0.9);
      transform: translateY(-0.5px);
      box-shadow: 0 0 0 1px rgba(129,140,248,0.7);
    }

    .page-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 18px;
    }

    /* LINKS: Team-Erstellung + Spielfeld */
    .lineup-wrapper {
      background: radial-gradient(circle at top, rgba(56,189,248,0.15), transparent 55%),
                  radial-gradient(circle at bottom, rgba(34,197,94,0.15), transparent 55%);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 16px;
    }
    .lineup-header h2 {
      font-size: 1.1rem;
      margin-bottom: 4px;
    }
    .lineup-header p {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .lineup-team-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-bottom: 10px;
      font-size: 0.8rem;
    }
    .lineup-team-bar label {
      color: #e5e7eb;
    }
    .lineup-team-bar input {
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 0.8rem;
      outline: none;
      min-width: 140px;
    }
    .team-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.85);
      padding: 4px 10px;
      font-size: 0.75rem;
      color: #e5e7eb;
      cursor: pointer;
      transition: background 0.1s, transform 0.08s, box-shadow 0.08s;
    }
    .team-btn:hover {
      background: rgba(30,64,175,0.9);
      transform: translateY(-0.5px);
      box-shadow: 0 0 0 1px rgba(129,140,248,0.7);
    }
    .team-btn.delete {
      border-color: rgba(248,113,113,0.8);
      color: #fecaca;
    }

    .pitch {
      position: relative;
      background: linear-gradient(180deg,#064e3b,#022c22);
      border-radius: 18px;
      border: 1px solid rgba(16,185,129,0.6);
      padding: 14px 10px 18px;
      min-height: 260px;
      box-shadow: inset 0 0 0 2px rgba(34,197,94,0.4);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .pitch-line {
      border-top: 1px solid rgba(209,250,229,0.4);
      margin: 0 8px;
    }
    .lineup-row {
      display: flex;
      justify-content: space-around;
      gap: 8px;
      padding: 4px 4px 0;
      flex-wrap: wrap;
    }
    .lineup-slot {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      min-width: 120px;
      max-width: 180px;
    }
    .lineup-slot label {
      font-size: 0.75rem;
      color: #d1fae5;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .lineup-slot select {
      width: 100%;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid rgba(16,185,129,0.7);
      background: rgba(15,23,42,0.9);
      color: #ecfdf5;
      font-size: 0.8rem;
      outline: none;
    }
    .lineup-slot select:focus {
      box-shadow: 0 0 0 1px rgba(52,211,153,0.8);
    }

    .lineup-team-info {
      margin-top: 10px;
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
    }
    .lineup-team-info span {
      font-weight: 600;
    }
    .team-ovr-value {
      font-family: "Bebas Neue", sans-serif;
      font-size: 1.8rem;
      letter-spacing: 0.06em;
      color: #bbf7d0;
    }

    /* RECHTS: Erstellte Teams */
    .teams-panel {
      background: rgba(15,23,42,0.9);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 14px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
    }
    .teams-panel h2 {
      font-size: 1rem;
      margin-bottom: 4px;
    }
    .teams-panel p {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 8px;
    }
    .teams-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 480px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .team-card {
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.5);
      padding: 8px 10px;
      background: rgba(15,23,42,0.9);
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
    }
    .team-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }
    .team-card-name {
      font-weight: 600;
    }
    .team-card-ovr {
      font-family: "Bebas Neue", sans-serif;
      font-size: 1.1rem;
      color: #bbf7d0;
    }
    .team-card-meta {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .team-card-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .team-card-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.85);
      padding: 3px 8px;
      font-size: 0.7rem;
      color: #e5e7eb;
      cursor: pointer;
      transition: background 0.1s, transform 0.08s, box-shadow 0.08s;
    }
    .team-card-btn:hover {
      background: rgba(30,64,175,0.9);
      transform: translateY(-0.5px);
      box-shadow: 0 0 0 1px rgba(129,140,248,0.7);
    }
    .team-card-btn.delete {
      border-color: rgba(248,113,113,0.8);
      color: #fecaca;
    }

    @media (max-width: 900px) {
      .page-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .pitch {
        min-height: 230px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="nav-row">
      <div>
        <h1>5v5 Aufstellung</h1>
        <p class="subtitle">Wähle 4 Feldspieler + 1 Torwart aus deinen Karten und speichere Teams.</p>
      </div>
      <a href="index.html" class="nav-btn">← Zurück zu den Karten</a>
    </div>

    <div class="page-grid">
      <!-- LINKS: Team erstellen / bearbeiten + Spielfeld -->
      <section class="lineup-wrapper">
        <div class="lineup-header">
          <h2>Team erstellen / bearbeiten</h2>
          <p>Gib einen Teamnamen ein, wähle Karten für die Positionen und speichere das Team.</p>
        </div>

        <div class="lineup-team-bar">
          <label for="teamNameInput">Teamname:</label>
          <input id="teamNameInput" type="text" placeholder="z.B. Team 1" />
          <button type="button" id="newTeamBtn" class="team-btn">Neu</button>
          <button type="button" id="saveTeamBtn" class="team-btn">Speichern</button>
        </div>

        <div class="pitch">
          <!-- Torwart -->
          <div class="lineup-row">
            <div class="lineup-slot">
              <label for="gkSelect">Torwart</label>
              <select id="gkSelect">
                <option value="">– Karte wählen –</option>
              </select>
            </div>
          </div>

          <div class="pitch-line"></div>

          <!-- 4 Feldspieler -->
          <div class="lineup-row">
            <div class="lineup-slot">
              <label for="p1Select">Spieler 1</label>
              <select id="p1Select">
                <option value="">– Karte wählen –</option>
              </select>
            </div>
            <div class="lineup-slot">
              <label for="p2Select">Spieler 2</label>
              <select id="p2Select">
                <option value="">– Karte wählen –</option>
              </select>
            </div>
          </div>

          <div class="lineup-row">
            <div class="lineup-slot">
              <label for="p3Select">Spieler 3</label>
              <select id="p3Select">
                <option value="">– Karte wählen –</option>
              </select>
            </div>
            <div class="lineup-slot">
              <label for="p4Select">Spieler 4</label>
              <select id="p4Select">
                <option value="">– Karte wählen –</option>
              </select>
            </div>
          </div>
        </div>

        <div class="lineup-team-info">
          <div>Team OVR (Durchschnitt der gewählten Karten):</div>
          <div class="team-ovr-value" id="teamOvrValue">-</div>
        </div>
      </section>

      <!-- RECHTS: Erstellte Teams -->
      <section class="teams-panel">
        <h2>Erstellte Teams</h2>
        <p>Hier siehst du alle gespeicherten Teams. Du kannst sie laden, bearbeiten oder löschen.</p>
        <div id="teamsList" class="teams-list"></div>
      </section>
    </div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>

  <script>
    const STAT_KEYS = ["PAC", "SHO", "PAS", "DRI", "DEF", "PHY"];
    const lineupSelectIds = ["gkSelect", "p1Select", "p2Select", "p3Select", "p4Select"];
    const teamOvrValueEl = document.getElementById("teamOvrValue");

    const teamNameInput = document.getElementById("teamNameInput");
    const newTeamBtn = document.getElementById("newTeamBtn");
    const saveTeamBtn = document.getElementById("saveTeamBtn");
    const teamsListEl = document.getElementById("teamsList");

    let currentDocs = [];      // Karten
    let currentLineups = [];   // Teams
    let currentLineupId = null;

    // Firebase Config (gleich wie auf der Karten-Seite)
    const firebaseConfig = {
      apiKey: "AIzaSyDPV1BoQLODeFcJea9GJ9TQFRYv_k6Jo00",
      authDomain: "karten-creator.firebaseapp.com",
      projectId: "karten-creator",
      storageBucket: "karten-creator.firebasestorage.app",
      messagingSenderId: "653062925464",
      appId: "1:653062925464:web:062ff9e541584a835cf4ed"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const cardsRef = db.collection("cards");
    const lineupsRef = db.collection("lineups");

    // Anonyme Anmeldung (wie auf Karten-Seite)
    auth.signInAnonymously()
      .then(() => {
        console.log("Anonym angemeldet (Aufstellung)");
      })
      .catch((error) => {
        console.error("Fehler bei anonymer Anmeldung:", error);
      });

    function calculateOverall(stats, position) {
      const s = {
        PAC: Number(stats.PAC) || 0,
        SHO: Number(stats.SHO) || 0,
        PAS: Number(stats.PAS) || 0,
        DRI: Number(stats.DRI) || 0,
        DEF: Number(stats.DEF) || 0,
        PHY: Number(stats.PHY) || 0,
      };

      const pos = String(position || "").toUpperCase();
      let ovr;

      if (pos === "ST" || pos === "LF" || pos === "RF") {
        ovr =
          0.40 * s.SHO +
          0.25 * s.PAC +
          0.20 * s.DRI +
          0.10 * s.PHY +
          0.05 * s.PAS;
      } else if (pos === "OM" || pos === "LM" || pos === "RM" || pos === "ZM") {
        ovr =
          0.30 * s.PAS +
          0.25 * s.DRI +
          0.20 * s.PAC +
          0.15 * s.SHO +
          0.10 * s.DEF;
      } else if (pos === "DM" || pos === "IV" || pos === "AV") {
        ovr =
          0.35 * s.DEF +
          0.25 * s.PHY +
          0.20 * s.PAC +
          0.10 * s.PAS +
          0.10 * s.DRI;
      } else if (pos === "TW") {
        ovr =
          0.40 * s.DEF +
          0.30 * s.PHY +
          0.20 * s.PAC +
          0.10 * s.DRI;
      } else {
        const sum = STAT_KEYS.reduce((acc, key) => acc + (s[key] || 0), 0);
        ovr = sum / STAT_KEYS.length;
      }

      return Math.round(ovr);
    }

    function populateLineupSelects() {
      lineupSelectIds.forEach((id) => {
        const sel = document.getElementById(id);
        if (!sel) return;
        const previous = sel.value;
        sel.innerHTML = '<option value="">– Karte wählen –</option>';

        currentDocs.forEach((doc) => {
          const d = doc.data;
          const ovr = calculateOverall(d.stats || {}, d.position || "");
          const label = `${d.name || "Unbekannt"} (${d.position || "POS"}, OVR ${ovr})`;
          const opt = document.createElement("option");
          opt.value = doc.id;
          opt.textContent = label;
          sel.appendChild(opt);
        });

        if (previous) {
          sel.value = previous;
        }
      });

      updateTeamOvr();
    }

    function updateTeamOvr() {
      let total = 0;
      let count = 0;

      lineupSelectIds.forEach((id) => {
        const sel = document.getElementById(id);
        if (!sel) return;
        const cardId = sel.value;
        if (!cardId) return;

        const doc = currentDocs.find(d => d.id === cardId);
        if (!doc) return;

        const d = doc.data;
        const ovr = calculateOverall(d.stats || {}, d.position || "");
        total += ovr;
        count++;
      });

      if (count === 0) {
        teamOvrValueEl.textContent = "-";
      } else {
        teamOvrValueEl.textContent = Math.round(total / count);
      }
    }

    lineupSelectIds.forEach((id) => {
      const sel = document.getElementById(id);
      if (sel) {
        sel.addEventListener("change", updateTeamOvr);
      }
    });

    // Live-Karten laden
    cardsRef.orderBy("createdAt").onSnapshot((snapshot) => {
      currentDocs = [];
      snapshot.forEach((doc) => {
        currentDocs.push({ id: doc.id, data: doc.data() });
      });
      populateLineupSelects();
    });

    // Live-Lineups laden
    lineupsRef.orderBy("createdAt").onSnapshot((snapshot) => {
      currentLineups = [];
      snapshot.forEach((doc) => {
        currentLineups.push({ id: doc.id, data: doc.data() });
      });
      renderTeamsList();
    });

    function renderTeamsList() {
      teamsListEl.innerHTML = "";

      if (currentLineups.length === 0) {
        const empty = document.createElement("div");
        empty.className = "team-card-meta";
        empty.textContent = "Noch keine Teams erstellt.";
        teamsListEl.appendChild(empty);
        return;
      }

      currentLineups.forEach((entry) => {
        const { id, data } = entry;
        const slots = data.slots || {};

        // Team-OVR berechnen auf Basis der gespeicherten Slots
        let total = 0;
        let count = 0;
        Object.values(slots).forEach((cardId) => {
          const cardDoc = currentDocs.find(d => d.id === cardId);
          if (!cardDoc) return;
          const d = cardDoc.data;
          const ovr = calculateOverall(d.stats || {}, d.position || "");
          total += ovr;
          count++;
        });
        const teamOvr = count > 0 ? Math.round(total / count) : "-";

        const playerCount = Object.keys(slots).length;

        const card = document.createElement("div");
        card.className = "team-card";
        card.dataset.id = id;

        card.innerHTML = `
          <div class="team-card-header">
            <span class="team-card-name">${data.name || "Ohne Name"}</span>
            <span class="team-card-ovr">${teamOvr === "-" ? "-" : "OVR " + teamOvr}</span>
          </div>
          <div class="team-card-meta">
            Spieler im Team: ${playerCount}
          </div>
          <div class="team-card-actions">
            <button type="button" class="team-card-btn load-btn">Laden</button>
            <button type="button" class="team-card-btn edit-btn">Bearbeiten</button>
            <button type="button" class="team-card-btn delete delete-btn">Löschen</button>
          </div>
        `;

        card.addEventListener("click", async (e) => {
          const loadBtn = e.target.closest(".load-btn");
          const editBtn = e.target.closest(".edit-btn");
          const delBtn  = e.target.closest(".delete-btn");

          if (loadBtn || editBtn) {
            // Team in die Felder laden
            currentLineupId = id;
            teamNameInput.value = data.name || "";
            const slotsData = data.slots || {};

            lineupSelectIds.forEach((slotId) => {
              const sel = document.getElementById(slotId);
              if (!sel) return;
              sel.value = slotsData[slotId] || "";
            });

            updateTeamOvr();
          }

          if (delBtn) {
            const really = confirm("Willst du dieses Team wirklich löschen?");
            if (!really) return;
            try {
              await lineupsRef.doc(id).delete();
              if (currentLineupId === id) {
                currentLineupId = null;
                teamNameInput.value = "";
                lineupSelectIds.forEach((slotId) => {
                  const sel = document.getElementById(slotId);
                  if (sel) sel.value = "";
                });
                updateTeamOvr();
              }
            } catch (err) {
              console.error("Fehler beim Löschen des Teams:", err);
              alert("Team konnte nicht gelöscht werden :(");
            }
          }
        });

        teamsListEl.appendChild(card);
      });
    }

    // Neues Team (Form leeren)
    newTeamBtn.addEventListener("click", () => {
      currentLineupId = null;
      teamNameInput.value = "";
      lineupSelectIds.forEach((id) => {
        const sel = document.getElementById(id);
        if (sel) sel.value = "";
      });
      updateTeamOvr();
    });

    // Team speichern (neu oder update)
    saveTeamBtn.addEventListener("click", async () => {
      const name = teamNameInput.value.trim();
      if (!name) {
        alert("Bitte gib einen Teamnamen ein.");
        return;
      }

      const slots = {};
      let hasAny = false;
      lineupSelectIds.forEach((id) => {
        const sel = document.getElementById(id);
        const val = sel ? sel.value : "";
        if (val) {
          slots[id] = val;
          hasAny = true;
        }
      });

      if (!hasAny) {
        alert("Wähle mindestens eine Karte für das Team aus.");
        return;
      }

      try {
        if (currentLineupId) {
          await lineupsRef.doc(currentLineupId).update({
            name,
            slots
          });
        } else {
          const docRef = await lineupsRef.add({
            name,
            slots,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          currentLineupId = docRef.id;
        }
      } catch (err) {
        console.error("Fehler beim Speichern des Teams:", err);
        alert("Team konnte nicht gespeichert werden :(");
      }
    });
  </script>
</body>
</html>
